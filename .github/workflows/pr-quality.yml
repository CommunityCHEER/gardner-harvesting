name: PR Quality Gates

on:
  pull_request:
    types: [opened, synchronize, edited, labeled, unlabeled]

jobs:
  architecture-docs-check:
    name: Ensure ADR/Tech Spec link for architecture PRs
    runs-on: ubuntu-latest
    steps:
      - name: Check PR has ADR/Tech Spec when labeled 'architecture'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) return core.info('No PR context; skipping.');
            const hasArchLabel = (pr.labels || []).some(l => l.name.toLowerCase() === 'architecture');
            if (!hasArchLabel) {
              core.info('No architecture label; skipping ADR/tech spec enforcement.');
              return;
            }

            // Check PR body for a docs link signal
            const body = pr.body || '';
            const bodyHasRef = /ADR:|docs\/adr\//i.test(body) || /tech\s*spec|techspec/i.test(body);

            // Fetch changed files and see if any ADR/techspec docs are included
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100,
            });
            const hasDocChange = files.some(f => /^(docs\/adr\/.*\.md|docs\/.*techspec.*\.md)$/i.test(f.filename));

            if (!bodyHasRef && !hasDocChange) {
              core.setFailed("PR labeled 'architecture' must link to or include an ADR/tech spec (add docs/adr/*.md) or include a link in the PR body.");
            } else {
              core.info('ADR/tech spec reference found.');
            }

  client-quality:
    name: Client type-check and typed lint (warn)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: emoda.client
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: |
            emoda.client/yarn.lock
            yarn.lock
      - name: Enable Corepack
        run: corepack enable
      - name: Install dependencies
        run: yarn install --immutable
      - name: Type check
        run: yarn type-check
      - name: Typed lint (warn mode)
        # Use non-blocking typed lint to collect warnings for future thresholding
        run: |
          yarn lint:typed:warn || true

  env-contract-drift:
    name: Environment contract drift (planned)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Validate environment contract
        run: node scripts/validate-env-contract.mjs
        continue-on-error: true

  commit-format-check:
    name: Validate Conventional Commits
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for commitlint
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
      
      - name: Enable Corepack
        run: corepack enable
      
      - name: Install dependencies
        run: yarn install --immutable
      
      - name: Validate commit messages
        run: |
          yarn dlx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose
